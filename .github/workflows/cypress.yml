name: Cypress Tests with Mochawesome Reporter

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]
  schedule:
    - cron: "0 6 * * *" # Daily at 6:00 AM UTC
  workflow_dispatch: # Manual trigger

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  cypress-tests:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome]

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: üß™ Run Cypress Tests
        run: npm run cy:run
        env:
          CYPRESS_BASE_URL: ${{ secrets.CYPRESS_BASE_URL }}
          CYPRESS_USERNAME: ${{ secrets.CYPRESS_USERNAME }}
          CYPRESS_PASSWORD: ${{ secrets.CYPRESS_PASSWORD }}
        continue-on-error: true

      - name: üìä Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-report-${{ matrix.browser }}-${{ github.run_number }}
          path: cypress/reports/
          retention-days: 30

      - name: üìß Send Email Report
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Cypress Test Report - Run #${{ github.run_number }} - ${{ job.status }}"
          body: |
            Cypress Test Report
            
            Workflow Run: #${{ github.run_number }}
            Status: ${{ job.status }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            
            Test report is available in GitHub Actions artifacts.
          to: ${{ secrets.EMAIL_USERNAME }}
          from: ${{ secrets.EMAIL_USERNAME }}
          attachments: cypress/reports/index.html
        continue-on-error: true

      - name: üí¨ Comment PR with Test Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'cypress/reports/index.html';
            
            if (fs.existsSync(reportPath)) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## üìä Cypress Test Report\n\n‚úÖ Tests completed successfully!\n\nView the full report in [GitHub Actions Artifacts](${context.payload.pull_request.head.repo.html_url}/actions/runs/${context.runId})`
              });
            }
        continue-on-error: true

      - name: ‚ùå Close PR on Test Failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Cypress tests failed. This PR is being closed automatically. Please review the test report and fix the issues.'
            });
            github.rest.pulls.update({
              pull_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
        continue-on-error: true

      - name: ‚úÖ Auto-Merge PR on Success
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ All Cypress tests passed! Merging this PR automatically.'
            });
            github.rest.pulls.merge({
              pull_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              merge_method: 'merge'
            });
        continue-on-error: true
